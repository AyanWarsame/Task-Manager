<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Manager</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Task Manager</h1>
            <p>Manage your tasks with ease</p>
        </div>

        <div class="content">
            <!-- Add Task Form -->
            <div class="task-form">
                <h2>Add New Task</h2>
                <form id="addTaskForm">
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" required placeholder="Enter task title" />
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" name="description" placeholder="Enter task description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="status">Status:</label>
                        <select id="status" name="status">
                            <option value="pending">Pending</option>
                            <option value="in progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Add Task</button>
                </form>
            </div>

            <!-- Tasks List -->
            <div class="tasks-list">
                <h2>Your Tasks</h2>
                <div id="tasksContainer"></div>
            </div>
        </div>
    </div>

  <script>
    // Use relative URLs since frontend is served from the same backend
    const API_BASE_URL = '';

    document.addEventListener('DOMContentLoaded', loadTasks);

    document.getElementById('addTaskForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            status: document.getElementById('status').value
        };

        try {
            const response = await fetch(`${API_BASE_URL}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                document.getElementById('addTaskForm').reset();
                loadTasks();
                showMessage('Task added successfully!', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to add task');
            }
        } catch (error) {
            showMessage('Error adding task: ' + error.message, 'error');
        }
    });

    async function loadTasks() {
        try {
            const response = await fetch(`${API_BASE_URL}/tasks`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const tasks = await response.json();
            displayTasks(tasks);
        } catch (error) {
            showMessage('Error loading tasks: ' + error.message, 'error');
            console.error('Load tasks error:', error);
        }
    }

    function displayTasks(tasks) {
        const container = document.getElementById('tasksContainer');

        if (!tasks || tasks.length === 0) {
            container.innerHTML = '<p>No tasks found. Add your first task above!</p>';
            return;
        }

        // Check if tasks is an array
        if (!Array.isArray(tasks)) {
            container.innerHTML = '<p>Error: Invalid tasks data</p>';
            return;
        }

        container.innerHTML = tasks.map(task => `
            <div class="task-item">
                <div class="task-header">
                    <div class="task-title">${escapeHtml(task.title)}</div>
                    <div class="task-status status-${task.status ? task.status.replace(' ', '-') : 'pending'}">
                        ${task.status ? task.status.toUpperCase() : 'PENDING'}
                    </div>
                </div>
                <div class="task-description">${task.description ? escapeHtml(task.description) : 'No description'}</div>
                <div class="task-meta">
                    Created: ${task.created_at ? new Date(task.created_at).toLocaleString() : 'Unknown'}
                </div>
                <div class="task-actions">
                    <button class="btn btn-update" onclick="updateTask(${task.id}, 'completed')">‚úÖ Complete</button>
                    <button class="btn btn-update" onclick="updateTask(${task.id}, 'in progress')">üîÑ In Progress</button>
                    <button class="btn btn-delete" onclick="deleteTask(${task.id})">üóëÔ∏è Delete</button>
                </div>
            </div>
        `).join('');
    }

    async function updateTask(taskId, newStatus) {
        try {
            // First get the current task details
            const tasksResponse = await fetch(`${API_BASE_URL}/tasks`);
            if (!tasksResponse.ok) {
                throw new Error('Failed to fetch tasks');
            }
            const tasks = await tasksResponse.json();
            const task = tasks.find(t => t.id === taskId);

            if (!task) throw new Error('Task not found');

            const updateData = {
                title: task.title,
                description: task.description,
                status: newStatus
            };

            const response = await fetch(`${API_BASE_URL}/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                loadTasks();
                showMessage('Task updated successfully!', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update task');
            }
        } catch (error) {
            showMessage('Error updating task: ' + error.message, 'error');
        }
    }

    async function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/tasks/${taskId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadTasks();
                showMessage('Task deleted successfully!', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete task');
            }
        } catch (error) {
            showMessage('Error deleting task: ' + error.message, 'error');
        }
    }

    function showMessage(message, type) {
        const existingMessage = document.querySelector('.message');
        if (existingMessage) existingMessage.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;

        document.querySelector('.content').insertBefore(messageDiv, document.querySelector('.tasks-list'));

        setTimeout(() => {
            if (messageDiv.parentElement) messageDiv.remove();
        }, 5000);
    }

    // Helper function to prevent XSS
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Optional: Auto-refresh every 30 seconds
    setInterval(loadTasks, 30000);
</script>
</body>
</html>
